import{e as pe,c as z,d as G,r as x,j as e,t as g}from"./index-BW1v2Y3o.js";import{u as _,s as W}from"./label-C5VtnZRZ.js";import{o as fe,s as Y}from"./index-B3p3PcZP.js";import{C as ye,a as ge,b as Ne,c as De,d as be}from"./card-Bb8dNGOw.js";import{B as c}from"./index-lZj-UG3P.js";import{I as Z}from"./input-B9pFp4AM.js";import{T as ee}from"./textarea-DMIEle1g.js";import{D as T,b as F,c as O,d as q,e as k,f as E}from"./dialog-CtifNpLo.js";import{T as ve,a as we,b as se,c as b,d as Ce,e as v}from"./table-DjxPWTM_.js";import{D as Te,a as Fe,b as Oe,c as B}from"./dropdown-menu-B6SE2GuO.js";import{F as te,a as K,b as S,c as j,d as M,e as V}from"./form-CBmUezT4.js";import{g as qe}from"./file-D5Y2yJfI.js";import{P as ne}from"./plus-Brih1OWA.js";import{F as w,U as ae,D as ke}from"./upload-D_Rj1oCM.js";import{E as Ee,a as Ke}from"./eye-quthMXAv.js";import{P as Se}from"./pencil-CU8hVN-1.js";import{T as Me}from"./trash-2-D3N7ccQE.js";import{X as L}from"./index-fdDP8kav.js";import{f as Ve}from"./format-CR5l4UVX.js";const Ge=(t,i,a,l)=>{const r=new FormData;return i.newFiles!==void 0&&i.newFiles.forEach(o=>r.append("newFiles",o)),G({url:`/api/profile-documents/${t}`,method:"PUT",headers:{"Content-Type":"multipart/form-data"},data:r,params:a},l)},Pe=t=>{const i=["updateDocument"],{mutation:a,request:l}=t?t.mutation&&"mutationKey"in t.mutation&&t.mutation.mutationKey?t:{...t,mutation:{...t.mutation,mutationKey:i}}:{mutation:{mutationKey:i},request:void 0};return{mutationFn:o=>{const{id:m,data:N,params:p}=o??{};return Ge(m,N,p,l)},...a}},He=(t,i)=>{const a=Pe(t);return z(a)},Ie=(t,i)=>G({url:`/api/profile-documents/${t}`,method:"DELETE"},i),Ae=t=>{const i=["deleteDocument"],{mutation:a,request:l}=t?t.mutation&&"mutationKey"in t.mutation&&t.mutation.mutationKey?t:{...t,mutation:{...t.mutation,mutationKey:i}}:{mutation:{mutationKey:i},request:void 0};return{mutationFn:o=>{const{id:m}=o??{};return Ie(m,l)},...a}},Xe=(t,i)=>{const a=Ae(t);return z(a)},Be=(t,i,a,l)=>{const r=new FormData;return t.files.forEach(o=>r.append("files",o)),G({url:"/api/profile-documents",method:"POST",headers:{"Content-Type":"multipart/form-data"},data:r,params:i,signal:l},a)},Le=t=>{const i=["createDocument"],{mutation:a,request:l}=t?t.mutation&&"mutationKey"in t.mutation&&t.mutation.mutationKey?t:{...t,mutation:{...t.mutation,mutationKey:i}}:{mutation:{mutationKey:i},request:void 0};return{mutationFn:o=>{const{data:m,params:N}=o??{};return Be(m,N,l)},...a}},ze=(t,i)=>{const a=Le(t);return z(a)},Ue=(t,i,a)=>G({url:`/api/profile-documents/${t}`,method:"GET",signal:a},i),Qe=t=>[`/api/profile-documents/${t}`],Re=(t,i)=>{const{query:a,request:l}={};return{queryKey:(a==null?void 0:a.queryKey)??Qe(t),queryFn:({signal:m})=>Ue(t,l,m),enabled:!!t,...a}};function $e(t,i,a){const l=Re(t),r=pe(l);return r.queryKey=l.queryKey,r}const ie=fe({name:Y().min(1,"Tên tài liệu không được để trống"),note:Y().optional()}),xs=({profile:t,canRead:i=!0,canUpdate:a=!0})=>{const[l,r]=x.useState(!1),[o,m]=x.useState(!1),[N,p]=x.useState(!1),[re,C]=x.useState(!1),[n,P]=x.useState(null),[d,H]=x.useState([]),[f,I]=x.useState([]),{data:U=[],refetch:A}=$e(t.id),{mutate:le}=Xe({mutation:{onSuccess:()=>{g("Xóa thành công",{description:"Tài liệu y tế đã được xóa."}),A()},onError:()=>{g.error("Xóa tài liệu thất bại")}}}),{mutate:ce}=ze({mutation:{onSuccess:()=>{g("Tạo tài liệu thành công",{description:"Tài liệu y tế đã được tạo."}),A()},onError:()=>{g.error("Tạo tài liệu thất bại")}},request:{headers:{"Content-Type":"multipart/form-data"}}}),{mutate:oe}=He({mutation:{onSuccess:()=>{g("Cập nhật thành công",{description:"Tài liệu y tế đã được cập nhật."}),A()},onError:()=>{g.error("Cập nhật tài liệu thất bại")}}}),y=_({resolver:W(ie),defaultValues:{name:"",note:""}}),u=_({resolver:W(ie),defaultValues:{name:"",note:""}}),D=()=>{y.reset(),u.reset(),H([]),I([])},Q=()=>{D(),r(!0)},R=s=>{P(s),u.reset({name:s.name,note:s.note}),I([]),m(!0)},me=s=>{P(s),p(!0)},de=s=>{P(s),C(!0)},he=s=>{ce({data:{files:d,name:s.name,note:s.note||"",profileId:t.id},params:{name:s.name,note:s.note||"",profileId:t.id}}),r(!1),D()},ue=s=>{n&&(oe({id:n.id,data:{newFiles:d,name:s.name,note:s.note||"",removeFiles:f},params:{name:s.name,note:s.note||"",removeFiles:f}}),m(!1),D())},xe=()=>{n&&(le({id:n.id}),C(!1))},$=s=>{if(s.target.files){const h=Array.from(s.target.files);H([...d,...h])}},X=(s,h=!1)=>{h?I([...f,s]):H(d.filter(je=>je.name!==s))},J=s=>Ve(new Date(s),"dd/MM/yyyy HH:mm");return i?e.jsxs(ye,{children:[e.jsxs(ge,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsxs("div",{children:[e.jsx(Ne,{children:"Tài liệu y tế"}),e.jsx(De,{children:"Quản lý các hồ sơ, đơn thuốc và tài liệu y tế"})]}),a&&e.jsxs(c,{onClick:Q,children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Thêm tài liệu"]})]}),e.jsxs(be,{children:[U.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(w,{className:"h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium",children:"Chưa có tài liệu y tế"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Thêm tài liệu y tế như kết quả xét nghiệm, đơn thuốc, hoặc báo cáo khám bệnh."}),e.jsxs(c,{className:"mt-4",onClick:Q,children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Thêm tài liệu đầu tiên"]})]}):e.jsxs(ve,{children:[e.jsx(we,{children:e.jsxs(se,{children:[e.jsx(b,{children:"Tên tài liệu"}),e.jsx(b,{children:"Ngày tạo"}),e.jsx(b,{children:"Ghi chú"}),e.jsx(b,{children:"Tệp đính kèm"}),e.jsx(b,{className:"w-[100px]"})]})}),e.jsx(Ce,{children:U.map(s=>e.jsxs(se,{children:[e.jsx(v,{className:"font-medium",children:s.name}),e.jsx(v,{children:J(s.createdAt)}),e.jsx(v,{children:s.note}),e.jsxs(v,{children:[s.attachments.length," tệp"]}),e.jsx(v,{children:e.jsxs(Te,{children:[e.jsx(Fe,{asChild:!0,children:e.jsx(c,{variant:"ghost",size:"icon",children:e.jsx(Ee,{className:"h-4 w-4"})})}),e.jsxs(Oe,{align:"end",children:[e.jsxs(B,{onClick:()=>me(s),children:[e.jsx(Ke,{className:"mr-2 h-4 w-4"}),"Xem"]}),a&&e.jsxs(e.Fragment,{children:[e.jsxs(B,{onClick:()=>R(s),children:[e.jsx(Se,{className:"mr-2 h-4 w-4"}),"Chỉnh sửa"]}),e.jsxs(B,{onClick:()=>de(s),children:[e.jsx(Me,{className:"mr-2 h-4 w-4"}),"Xóa"]})]})]})]})})]},s.id))})]}),e.jsx(T,{open:l,onOpenChange:s=>{s||D(),r(s)},children:e.jsxs(F,{className:"sm:max-w-md",children:[e.jsxs(O,{children:[e.jsx(q,{children:"Thêm tài liệu y tế"}),e.jsxs(k,{children:["Tải lên tài liệu y tế cho hồ sơ của"," ",t.fullName||"bạn"]})]}),e.jsx(te,{...y,children:e.jsxs("form",{onSubmit:y.handleSubmit(he),className:"space-y-4 py-4",children:[e.jsx(K,{control:y.control,name:"name",render:({field:s})=>e.jsxs(S,{children:[e.jsx(j,{children:"Tên tài liệu"}),e.jsx(M,{children:e.jsx(Z,{placeholder:"VD: Kết quả xét nghiệm, Đơn thuốc...",...s})}),e.jsx(V,{})]})}),e.jsx(K,{control:y.control,name:"note",render:({field:s})=>e.jsxs(S,{children:[e.jsx(j,{children:"Ghi chú"}),e.jsx(M,{children:e.jsx(ee,{placeholder:"Thêm thông tin chi tiết về tài liệu này",rows:3,...s})}),e.jsx(V,{})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Tệp đính kèm"}),e.jsxs("div",{className:"border rounded-md p-4",children:[d.length>0&&e.jsx("div",{className:"space-y-2 mb-4",children:d.map((s,h)=>e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 p-2 rounded",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"text-sm truncate max-w-[200px]",children:s.name})]}),e.jsx(c,{variant:"ghost",size:"icon",type:"button",onClick:()=>X(s.name),children:e.jsx(L,{className:"h-4 w-4"})})]},h))}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("label",{htmlFor:"add-files",className:"cursor-pointer",children:[e.jsxs("div",{className:"flex flex-col items-center gap-1 py-4",children:[e.jsx(ae,{className:"h-8 w-8 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Tải lên tệp"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"PDF, JPG, PNG (tối đa 10MB)"})]}),e.jsx("input",{id:"add-files",type:"file",multiple:!0,required:!0,className:"hidden",onChange:$})]})})]}),d.length===0&&e.jsx("p",{className:"text-sm text-destructive",children:"Vui lòng tải lên ít nhất một tệp"})]}),e.jsxs(E,{className:"sm:justify-end pt-4",children:[e.jsx(c,{variant:"outline",type:"button",onClick:()=>r(!1),children:"Hủy"}),e.jsx(c,{type:"submit",disabled:!y.formState.isValid||d.length===0,children:"Lưu"})]})]})})]})}),e.jsx(T,{open:N,onOpenChange:p,children:e.jsxs(F,{className:"sm:max-w-md",children:[e.jsxs(O,{children:[e.jsx(q,{children:n==null?void 0:n.name}),e.jsxs(k,{children:["Được tạo vào:"," ",n&&J(n.createdAt)]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Ghi chú"}),e.jsx("p",{className:"text-sm",children:(n==null?void 0:n.note)||"Không có ghi chú"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Tệp đính kèm"}),e.jsx("div",{className:"border rounded-md p-2 divide-y",children:n==null?void 0:n.attachments.map((s,h)=>e.jsxs("div",{className:"flex items-center justify-between py-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"text-sm",children:s})]}),e.jsxs(c,{variant:"ghost",size:"sm",onClick:()=>{window.open(qe(s),"_blank")},children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Tải xuống"]})]},h))})]})]}),e.jsxs(E,{className:"sm:justify-end",children:[e.jsx(c,{variant:"outline",onClick:()=>p(!1),children:"Đóng"}),e.jsx(c,{onClick:()=>{p(!1),n&&R(n)},children:"Chỉnh sửa"})]})]})}),e.jsx(T,{open:o,onOpenChange:s=>{s||D(),m(s)},children:e.jsxs(F,{className:"sm:max-w-md",children:[e.jsxs(O,{children:[e.jsx(q,{children:"Chỉnh sửa tài liệu y tế"}),e.jsxs(k,{children:['Cập nhật thông tin cho tài liệu "',n==null?void 0:n.name,'"']})]}),e.jsx(te,{...u,children:e.jsxs("form",{onSubmit:u.handleSubmit(ue),className:"space-y-4 py-4",children:[e.jsx(K,{control:u.control,name:"name",render:({field:s})=>e.jsxs(S,{children:[e.jsx(j,{children:"Tên tài liệu"}),e.jsx(M,{children:e.jsx(Z,{placeholder:"VD: Kết quả xét nghiệm, Đơn thuốc...",...s})}),e.jsx(V,{})]})}),e.jsx(K,{control:u.control,name:"note",render:({field:s})=>e.jsxs(S,{children:[e.jsx(j,{children:"Ghi chú"}),e.jsx(M,{children:e.jsx(ee,{placeholder:"Thêm thông tin chi tiết về tài liệu này",rows:3,...s})}),e.jsx(V,{})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Tệp hiện tại"}),e.jsx("div",{className:"border rounded-md p-2 divide-y",children:n==null?void 0:n.attachments.map((s,h)=>!f.includes(s)&&e.jsxs("div",{className:"flex items-center justify-between py-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"text-sm",children:s})]}),e.jsx(c,{variant:"ghost",size:"icon",type:"button",onClick:()=>X(s,!0),children:e.jsx(L,{className:"h-4 w-4"})})]},h))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Thêm tệp mới"}),e.jsxs("div",{className:"border rounded-md p-4",children:[d.length>0&&e.jsx("div",{className:"space-y-2 mb-4",children:d.map((s,h)=>e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 p-2 rounded",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"text-sm truncate max-w-[200px]",children:s.name})]}),e.jsx(c,{variant:"ghost",size:"icon",type:"button",onClick:()=>X(s.name),children:e.jsx(L,{className:"h-4 w-4"})})]},h))}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("label",{htmlFor:"edit-files",className:"cursor-pointer",children:[e.jsxs("div",{className:"flex flex-col items-center gap-1 py-4",children:[e.jsx(ae,{className:"h-8 w-8 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Tải lên tệp"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"PDF, JPG, PNG (tối đa 10MB)"})]}),e.jsx("input",{id:"edit-files",type:"file",multiple:!0,className:"hidden",onChange:$})]})})]}),f.length===(n==null?void 0:n.attachments.length)&&d.length===0&&e.jsx("p",{className:"text-sm text-destructive",children:"Vui lòng giữ lại ít nhất một tệp hoặc tải lên tệp mới"})]}),e.jsxs(E,{className:"sm:justify-end pt-4",children:[e.jsx(c,{variant:"outline",type:"button",onClick:()=>m(!1),children:"Hủy"}),e.jsx(c,{type:"submit",disabled:!u.formState.isValid||f.length===(n==null?void 0:n.attachments.length)&&d.length===0,children:"Lưu thay đổi"})]})]})})]})}),e.jsx(T,{open:re,onOpenChange:C,children:e.jsxs(F,{className:"sm:max-w-md",children:[e.jsxs(O,{children:[e.jsx(q,{children:"Xác nhận xóa tài liệu"}),e.jsxs(k,{children:['Bạn có chắc chắn muốn xóa tài liệu "',n==null?void 0:n.name,'"? Hành động này không thể hoàn tác.']})]}),e.jsxs(E,{className:"sm:justify-end",children:[e.jsx(c,{variant:"outline",onClick:()=>C(!1),children:"Hủy"}),e.jsx(c,{variant:"destructive",onClick:xe,children:"Xóa tài liệu"})]})]})})]})]}):e.jsx("div",{className:"text-red-500",children:"Bạn không có quyền truy cập vào tài liệu y tế này."})};export{xs as M};

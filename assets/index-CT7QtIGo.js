import{r as Q,S as X,o as q,T as z,U as K,j as e,s as u,t as m,V as l,W as I}from"./index-BW1v2Y3o.js";import{g as D,A as _}from"./index-Bvgfl4DN.js";import{D as B,a as U,b as G,c as J,d as Z,e as ee}from"./drawer-CY_oHpP7.js";import{B as d}from"./index-lZj-UG3P.js";import{I as se}from"./input-B9pFp4AM.js";import{T as ae}from"./textarea-DMIEle1g.js";import{F as ne,c as p,a as v,b as N,d as A,e as P}from"./form-CBmUezT4.js";import{P as ie,a as re,b as te,C as le}from"./popover-DmVzagL2.js";import{S as ce,a as oe,b as he,c as me,d as O}from"./select-D2Gb7fMh.js";import{C as de}from"./checkbox-Do6_XIjt.js";import{C as k}from"./card-Bb8dNGOw.js";import{z as t}from"./index-B3p3PcZP.js";import{u as xe,s as ue}from"./label-C5VtnZRZ.js";import{T as pe,a as ge,b as F,c as L}from"./tabs-Bg8Hq9Zq.js";import{f as je}from"./format-CR5l4UVX.js";const o={VIEW:"VIEW",EDIT:"EDIT",CREATE:"CREATE"},g={AnyOneWithLink:"AnyOneWithLink",OnlyInvitedPeople:"OnlyInvitedPeople"},fe=t.object({profileId:t.coerce.number().nullish(),accessType:t.enum(["link","email"]),doctorEmail:t.string().email().optional(),sharedData:t.array(t.object({field:t.nativeEnum(l),permissions:t.array(t.nativeEnum(o))})).min(1,"Chọn ít nhất một loại thông tin để chia sẻ"),reason:t.string().optional(),expiresAt:t.date()}),E={[l.PROFILE]:"Hồ sơ y tế cơ bản",[l.MEDICAL_RECORD]:"Lịch sử khám bệnh",[l.FILE_DOCUMENT]:"Tài liệu y tế",[l.PRESCRIPTION]:"Đơn thuốc",[l.VACCINATION]:"Lịch sử tiêm ngừa"};function Fe({type:S="family",familyId:j,memberId:f}){const[R,T]=Q.useState(!1),{data:h}=X({familyId:j,memberId:f}),w=q(),{mutate:V}=z({mutation:{onSuccess:()=>{m.success("Xoá chia sẻ thành công!"),w.invalidateQueries({queryKey:I({familyId:j,memberId:f})})},onError:()=>{m.error("Xoá chia sẻ thất bại!")}}}),n=xe({resolver:ue(fe),defaultValues:{accessType:"email",sharedData:[],expiresAt:new Date(Date.now()+7*24*60*60*1e3)}}),{mutate:M}=K({mutation:{onSuccess:()=>{m.success("Chia sẻ hồ sơ thành công!"),w.invalidateQueries({queryKey:I({familyId:j,memberId:f})}),n.reset()},onError:()=>{m.error("Chia sẻ hồ sơ thất bại!")}}}),Y=s=>{console.log("Share form values:",s),M({data:{invitedEmails:s.accessType==="email"?[s.doctorEmail]:[],expiresAt:u(s.expiresAt).format("YYYY-MM-DDTHH:mm:ss"),reason:s.reason,memberId:S==="member"?f:void 0,familyId:j,sharePermissions:s.sharedData.map(a=>({permissionTypes:a.permissions.map(i=>i),resourceType:a.field})),shareType:s.accessType==="link"?g.AnyOneWithLink:g.OnlyInvitedPeople}}),T(!1)},W=(s,a)=>{const i=n.watch("sharedData").find(c=>c.field===s);return i==null?void 0:i.permissions.includes(a)},$=(s,a)=>{const i=n.getValues("sharedData"),c=i.findIndex(r=>r.field===s);if(c===-1)n.setValue("sharedData",[...i,{field:s,permissions:[a]}]);else{const r=i[c],x=r.permissions.indexOf(a);let y;x===-1?y=[...r.permissions,a]:y=r.permissions.filter(C=>C!==a);let b;y.length===0?b=i.filter(C=>C.field!==s):(b=[...i],b[c]={field:s,permissions:y}),n.setValue("sharedData",b)}},H=s=>{V({id:s}),m.success("Xoá chia sẻ thành công!")};return e.jsxs(B,{open:R,onOpenChange:T,direction:"right",children:[e.jsx(U,{asChild:!0,children:e.jsxs(d,{className:"bg-green-400 hover:bg-green-500",children:[e.jsx(D,{className:"mr-2 h-4 w-4"}),"Chia sẻ hồ sơ y tế"]})}),e.jsxs(G,{className:"!max-w-3xl",children:[e.jsxs(J,{children:[e.jsxs(Z,{children:["Chia sẻ hồ sơ y tế"," ",S==="family"?"toàn bộ gia đình":"thành viên"]}),e.jsx(ee,{children:"Chọn thông tin bạn muốn chia sẻ hoặc xem lại danh sách đã chia sẻ."})]}),e.jsxs(pe,{defaultValue:"shareList",children:[e.jsxs(ge,{children:[e.jsx(F,{value:"shareList",children:"Danh sách chia sẻ"}),e.jsx(F,{value:"create",children:"Tạo chia sẻ"})]}),e.jsx(L,{value:"shareList",className:"py-1 px-2 overflow-auto max-h-[80vh]",children:(h==null?void 0:h.length)===0?e.jsxs("div",{className:"flex flex-col items-center justify-center p-10  text-center",children:[e.jsx("div",{className:"rounded-full bg-gray-100 p-4 mb-4",children:e.jsx(D,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium mb-1",children:"Chưa có chia sẻ nào"}),e.jsx("p",{className:"text-gray-500 max-w-md",children:"Tạo chia sẻ mới để cho phép bác sĩ hoặc người thân xem thông tin y tế của bạn"})]}):e.jsx("div",{className:"space-y-4 ",children:h==null?void 0:h.map(s=>{var a,i,c;return e.jsx(k,{className:"overflow-hidden border py-2 border-gray-200 hover:border-gray-300 transition-all",children:e.jsxs("div",{className:"flex flex-col md:flex-row",children:[e.jsxs("div",{className:"p-4 flex-1",children:[e.jsxs("div",{className:"flex items-center mb-3",children:[e.jsx("div",{className:`px-2 py-1 rounded-full text-xs font-medium mr-2 
                  ${s.shareType===g.AnyOneWithLink?"bg-blue-100 text-blue-800":"bg-purple-100 text-purple-800"}`,children:s.shareType===g.AnyOneWithLink?"Link công khai":"Qua email"}),e.jsxs("div",{className:`px-2 py-1 rounded-full text-xs font-medium
                  ${u(s.expiresAt).isAfter(u().add(5,"day"))?"bg-green-100 text-green-800":"bg-amber-100 text-amber-800"}`,children:["Hết hạn:"," ",u(s.expiresAt).format("DD/MM/YYYY")]})]}),e.jsx("div",{className:"mb-3",children:s.invitedEmails&&s.invitedEmails.length>0&&e.jsxs("div",{className:"flex items-center text-sm text-gray-600 mb-2",children:[e.jsx("span",{className:"font-medium mr-2",children:"Người nhận:"}),s.invitedEmails.map((r,x)=>e.jsx("span",{className:"bg-gray-100 px-2 py-1 rounded mr-1",children:r},x))]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium mb-1",children:["Thông tin được chia sẻ:"," "]}),e.jsx("div",{className:"text-sm font-medium mb-2 ",children:s.memberId!=null?"1 Thành viên: "+((i=(a=s.member)==null?void 0:a.profile)==null?void 0:i.fullName):"Toàn bộ gia đình"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:(c=s.sharePermissions)==null?void 0:c.map(r=>{const x=E[r.resourceType];return e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm flex items-center",children:[e.jsx("span",{className:"font-medium mr-1",children:x}),e.jsxs("div",{className:"flex gap-1",children:[r.permissionTypes.includes(o.VIEW)&&e.jsx("span",{className:"bg-blue-100 text-blue-800 px-1 rounded text-xs",children:"Xem"}),r.permissionTypes.includes(o.EDIT)&&e.jsx("span",{className:"bg-amber-100 text-amber-800 px-1 rounded text-xs",children:"Sửa"}),r.permissionTypes.includes(o.CREATE)&&e.jsx("span",{className:"bg-green-100 text-green-800 px-1 rounded text-xs",children:"Thêm"})]})]},r.id)})})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 flex flex-row md:flex-col justify-between items-center border-t md:border-t-0 md:border-l border-gray-200",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["Tạo ngày:"," ",u(s.createdAt).format("DD/MM/YYYY")]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[s.shareType===g.AnyOneWithLink&&e.jsxs(d,{variant:"outline",size:"sm",className:"flex items-center",onClick:()=>{navigator.clipboard.writeText(`${window.location.origin}/home/share/${s.id}`),m.success("Đã sao chép đường dẫn chia sẻ!")},children:[e.jsx(D,{className:"mr-1 h-3 w-3"}),"Sao chép link"]}),e.jsx(d,{variant:"destructive",size:"sm",onClick:()=>H(s.id),children:"Xoá chia sẻ"})]})]})]})},s.id)})})}),e.jsx(L,{value:"create",className:"overflow-auto max-h-[80vh]",children:e.jsx(ne,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(Y),className:"space-y-6 p-6 overflow-auto",children:[e.jsxs("div",{children:[e.jsx(p,{className:"text-base font-medium mb-3 block",children:"Thông tin và quyền chia sẻ"}),e.jsx("div",{className:"space-y-3",children:Object.keys(E).map(s=>e.jsxs(k,{className:"p-4 gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-medium",children:E[s]}),e.jsx("div",{className:"flex space-x-2",children:Object.values(o).map(a=>e.jsxs("div",{className:"flex items-center",children:[e.jsx(de,{id:`${s}-${a}`,checked:W(s,a),onCheckedChange:()=>$(s,a),className:"mr-1.5"}),e.jsxs("label",{htmlFor:`${s}-${a}`,className:"text-sm",children:[a===o.VIEW&&"Xem",a===o.CREATE&&"Thêm",a===o.EDIT&&"Sửa"]})]},`${s}-${a}`))})]}),e.jsxs("p",{className:"text-sm text-gray-500",children:[s===l.PROFILE&&"Thông tin cơ bản như chiều cao, cân nặng, nhóm máu...",s===l.MEDICAL_RECORD&&"Các lần khám và chẩn đoán",s===l.PRESCRIPTION&&"Đơn thuốc và hướng dẫn sử dụng",s===l.VACCINATION&&"Thông tin về các mũi tiêm đã thực hiện",s===l.FILE_DOCUMENT&&"Kết quả xét nghiệm, chụp chiếu và giấy tờ y tế"]})]},s))}),n.formState.errors.sharedData&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:n.formState.errors.sharedData.message})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(v,{control:n.control,name:"accessType",render:({field:s})=>e.jsxs(N,{children:[e.jsx(p,{children:"Phương thức chia sẻ"}),e.jsxs(ce,{onValueChange:s.onChange,value:s.value,children:[e.jsx(A,{children:e.jsx(oe,{className:"w-full",children:e.jsx(he,{})})}),e.jsxs(me,{children:[e.jsx(O,{value:"email",children:"Qua email"}),e.jsx(O,{value:"link",children:"Bất kì ai có đường dẫn"})]})]})]})}),n.watch("accessType")==="email"&&e.jsx(v,{control:n.control,name:"doctorEmail",render:({field:s})=>e.jsxs(N,{children:[e.jsx(p,{children:"Email người nhận"}),e.jsx(se,{type:"email",placeholder:"Nhập email người nhận",...s}),e.jsx(P,{})]})})]}),e.jsx(v,{control:n.control,name:"expiresAt",render:({field:s})=>e.jsxs(N,{children:[e.jsx(p,{children:"Thời hạn chia sẻ"}),e.jsxs(ie,{children:[e.jsx(re,{asChild:!0,children:e.jsx(A,{children:e.jsxs(d,{variant:"outline",className:"w-full md:w-auto",children:[s.value?je(s.value,"dd/MM/yyyy"):"Chọn ngày",e.jsx(_,{className:"ml-2 h-4 w-4"})]})})}),e.jsx(te,{className:"w-auto p-0",children:e.jsx(le,{mode:"single",selected:s.value,onSelect:s.onChange,initialFocus:!0,disabled:a=>a<new Date})})]}),e.jsx(P,{})]})}),e.jsx(v,{control:n.control,name:"reason",render:({field:s})=>e.jsxs(N,{children:[e.jsx(p,{children:"Lý do chia sẻ (tuỳ chọn)"}),e.jsx(ae,{placeholder:"Nhập lý do chia sẻ...",className:"resize-none",...s})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(d,{type:"button",variant:"outline",onClick:()=>T(!1),children:"Hủy"}),e.jsx(d,{type:"submit",className:"bg-green-500 hover:bg-green-600",children:"Tạo chia sẻ"})]})]})})})]})]})]})}export{Fe as S};
